<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Dojo loader mapping after build test</title>
</head>
<body>
	<script>
		var dojoConfig = {
			async: true,
			packages: [
				{
					name: 'test',
					location: './tests/_base/loader/mapping-multi-layer'
				},
				{
					name: 'app1',
					location: './tests/_base/loader/mapping-multi-layer/App1'
				},
				{
					name: 'app2',
					location: './tests/_base/loader/mapping-multi-layer/App2'
				},
				{
					name: 'common1',
					location: './tests/_base/loader/mapping-multi-layer/Common1'
				},
				{
					name: 'common2',
					location: './tests/_base/loader/mapping-multi-layer/Common2'
				},
				{
					name: 'router',
					location: './tests/_base/loader/mapping-multi-layer/Router'
				},
				{
					name: 'mappedModule',
					location: './tests/_base/loader/mapping-multi-layer/MappedModule'
				}
			],
			map: {
				'app1': {
					'common': 'common1'
				},
				'app2': {
					'common': 'common2'
				},
				'my/replacement/A': {
					'my/A': 'my/A'
				},
				'*': {
					'starmap/demo1': 'router/demoA',
					'starmap/demo2': 'router/demoB',
					'starmapModule': 'mappedModule',
					'my/A': 'my/replacement/A'
				}
			}
		};
	</script>
	<script src="../../../dojo.js"></script>
	<script>
		
		!require.async && require(['dojo']);
		require.boot && require.apply(null, require.boot);

		require([ 'doh' ], function (doh) {
			// begin test:
			// moving modules from the pending cache to the module cache should ignore
			// any mapping, pathing, or alias rules

			doh.register('multi-layer-mapping', [
				{
					name: 'mapping after multi layer build',
					timeout: 1500,
					runTest: function (t) {
						var def = new doh.Deferred();
						var expected = ["Common1/another:cache", "Router/demoB:nocache", "App1/thing:cache", "Router/demoC:cache", "Router/demoA:cache", "MappedModule/mappedC:cache", "mappedModule/mappedA:cache", "my/B:cache", "my/A:cache", "my/replacement/A:cache", "mainRequire1:loaded", "Common2/anotherone:cache", "Common2/another:cache", "mappedModule/mappedB:cache", "App2/thing:cache", "mainRequire2:loaded"];
						t.requireHandle = require.on('error', function (e) {
							def.errback(e);
						});
						require(['test/main'], function () {
							setTimeout(def.getTestCallback(function() {
								t.is(expected.join(), results.join(), 'mapping failed');
							}), 1000);
						});

						return def;
					},
					tearDown: function (t) {
						t.requireHandle.remove();
					}
				}
			]);
			doh.runOnLoad();
		});
	</script>
</body>
</html>
